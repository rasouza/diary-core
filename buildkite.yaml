env:
  IMAGE_NAME: "rasouza/diary-core"
  IMAGE_TAG: ${BUILDKITE_COMMIT:0:7}

steps:
  - name: ":hammer:"
    command: 
      - docker build --target build -t diary-core .

  - wait
  
  - name: ":stylelint:"
    command:
      - docker build --target lint -t diary-core .
      - docker run --rm diary-core 

  - wait

  - name: ":codeclimate:"
    command:
      - docker build --target testing -t diary-core .
      - mkdir -p coverage
      - cc-test-reporter before-build
      - docker run --name diary-core diary-core
      - docker cp diary-core:/opt/diary-core/coverage/lcov.info coverage/lcov.info
      - cc-test-reporter after-build
      - docker rm -f diary-core

  - wait
  
  - name: ":nodejs:"
    branches: master
    command:
      - docker build --build-arg token=$GH_TOKEN --target release -t diary-core .
      - docker run --rm diary-core # Create release notes
      
  - wait
  
  - name: ":docker: ${IMAGE_TAG}"
    branches: master
    command:
      - docker build -t ${IMAGE_NAME}:${IMAGE_TAG} -t ${IMAGE_NAME}:latest .
      - docker push ${IMAGE_NAME}
              
  - wait

  - name: ":rocket:"
    branches: master
    trigger: diary-deploy
    build:
      message: "${BUILDKITE_MESSAGE}"
      env:
        IMAGE_TAG: ${BUILDKITE_COMMIT:0:7}
        SERVICE: core